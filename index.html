<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>教會事奉表</title>

  <style>
    .row-hit td { background: #E8F2FF; }
    td.highlight { background: #eed85a; font-weight:600; }

    .controls{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
      padding:10px;
      background:#fff;
      position:sticky;
      top:0;
      z-index:20;
      border-bottom:1px solid #eee;
    }
    .controls select,
    .controls input,
    .controls button{
      font-size:16px;
      padding:10px 12px;
    }

    .table-wrap{
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      border:1px solid #eee;
      border-radius:10px;
    }
    table{
      border-collapse:collapse;
      width:max-content;
      min-width:100%;
    }
    th, td{
      border:1px solid #ddd;
      padding:10px 12px;
      white-space:nowrap;
      text-align:left;
    }
    thead th{
      background:#f6f6f6;
    }
  </style>
</head>

<body>

  <div class="controls">
    <label>
      選擇同工：
      <select id="personSelect">
        <option value="">（請選擇）</option>
      </select>
    </label>

    <label>
      搜尋：
      <input id="personFilter" type="text" placeholder="輸入任一字…" autocomplete="off">
    </label>

    <button id="clearBtn" type="button">清除</button>
    <button id="exportIcsBtn" type="button">加入到日曆</button>

    <span id="occCount">出現次數：0</span>
    <span id="dayCount">有幾天：0</span>
    <span id="hitPeople" style="margin-left:8px;">命中人數：0</span>
  </div>

 
  <div class="table-wrap">
    <table id="roster">
      <thead>
        <tr>
          <th>日期</th>
          <th>會前禱告</th>
          <th>講員</th>
          <th>敬拜主領</th>
          <th>敬拜Vocal</th>
          <th>樂團</th>
          <th>報告</th>
          <th>擘餅</th>
          <th>投影</th>
          <th>總音控</th>
          <th>架設直播</th>
          <th>招待奉獻</th>
          <th>兒主老師</th>
          <th>備註</th>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td>2026-01-04</td>
          <td>盈君</td>
          <td>高詩清牧師</td>
          <td>文祺、以帆</td>
          <td>小以琳</td>
          <td>琴:伶安｜吉:宗明｜鼓:睿甫｜斯:季如</td>
          <td>昶翰</td>
          <td>盈君、宗明</td>
          <td>凱鈞</td>
          <td>至忠</td>
          <td>莞茹</td>
          <td>樂樂、玠勻</td>
          <td>可馨</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-01-11</td>
          <td>雅親</td>
          <td>高詩清牧師</td>
          <td>可馨、宗明</td>
          <td>盈君</td>
          <td>琴:遠晟｜吉:昶翰｜鼓:儇齊｜斯:響萱</td>
          <td>文祺</td>
          <td></td>
          <td>薰聲</td>
          <td>欣仁</td>
          <td>萬隆</td>
          <td>季如</td>
          <td>凱鈞</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-01-18</td>
          <td>莞茹</td>
          <td>李惠知牧師</td>
          <td>以帆、至忠、儇齊、為聖</td>
          <td></td>
          <td>琴:可馨｜吉:紹華｜鼓:睿甫｜斯:至忠</td>
          <td>宗明</td>
          <td></td>
          <td>莞茹</td>
          <td>宇睿</td>
          <td>薰聲</td>
          <td>盈君</td>
          <td>昶翰</td>
          <td>牧養同工會 15:00</td>
        </tr>

        <tr>
          <td>2026-01-25</td>
          <td>季如</td>
          <td>謝尚儒傳道</td>
          <td>伶安</td>
          <td>孟璇、昶翰</td>
          <td>琴:睿甫｜吉:文祺｜鼓:為聖｜斯:以帆</td>
          <td>惠知</td>
          <td></td>
          <td>湘絨</td>
          <td>至忠</td>
          <td>欣仁</td>
          <td>雅親</td>
          <td>盈君</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-02-01</td>
          <td>孟璇</td>
          <td>高詩清牧師</td>
          <td>文祺</td>
          <td>紹華、榕榕</td>
          <td>琴:遠晟｜吉:以帆｜鼓:儇齊｜斯:響萱</td>
          <td>昶翰</td>
          <td>昶翰、莞茹</td>
          <td>欣仁</td>
          <td>睿甫</td>
          <td>萬隆</td>
          <td>湘絨</td>
          <td>宇睿</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-02-08</td>
          <td>凱鈞</td>
          <td>李惠知牧師</td>
          <td>可馨、儇齊</td>
          <td>愛真、樂樂、玠勻、予希、宜佑、雅筑</td>
          <td>琴:為聖｜吉:紹華｜鼓:睿甫｜斯:季如</td>
          <td>文祺</td>
          <td></td>
          <td>盈君</td>
          <td>萬隆</td>
          <td>欣仁</td>
          <td>孟璇</td>
          <td>莞茹</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-02-15</td>
          <td colspan="13">春節主日（暫停）</td>
        </tr>

        <tr>
          <td>2026-02-22</td>
          <td>雅親</td>
          <td>蘇麗容牧師</td>
          <td>宗明</td>
          <td>凱鈞、盈君</td>
          <td>琴:可馨｜吉:文祺｜鼓:為聖｜斯:以帆</td>
          <td>惠知</td>
          <td></td>
          <td>薰聲</td>
          <td>欣仁</td>
          <td>莞茹</td>
          <td>季如</td>
          <td>小以琳</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-03-01</td>
          <td>盈君</td>
          <td>王天佑牧師</td>
          <td>伶安、為聖</td>
          <td>小以琳</td>
          <td>琴:遠晟｜吉:以帆｜鼓:儇齊｜斯:至忠</td>
          <td>宗明</td>
          <td></td>
          <td>凱鈞</td>
          <td>睿甫</td>
          <td>薰聲</td>
          <td>愛真、宜宥</td>
          <td>可馨</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-03-08</td>
          <td>宗明</td>
          <td>高詩清牧師</td>
          <td>惠知、至忠</td>
          <td>小以琳</td>
          <td>琴:可馨｜吉:宗明｜鼓:為聖｜斯:季如</td>
          <td>昶翰</td>
          <td>文祺、凱鈞</td>
          <td>盈君</td>
          <td>欣仁</td>
          <td>萬隆</td>
          <td>雅親</td>
          <td>宇睿</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-03-15</td>
          <td>昶翰</td>
          <td>李惠知牧師</td>
          <td>可馨</td>
          <td>孟璇、昶翰</td>
          <td>琴:伶安｜吉:紹華｜鼓:睿甫｜斯:響萱<td>
          <td>文祺</td>
          <td></td>
          <td>欣仁</td>
          <td>宗明</td>
          <td>莞茹</td>
          <td>湘絨</td>
          <td>盈君</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-03-22</td>
          <td>季如</td>
          <td>高詩清牧師</td>
          <td>伶安</td>
          <td>凱鈞、愛真</td>
          <td>琴:為聖｜吉:宗明｜鼓:遠晟｜斯:以帆</td>
          <td>惠知</td>
          <td></td>
          <td>湘絨</td>
          <td>宇睿</td>
          <td>欣仁</td>
          <td>孟璇</td>
          <td>莞茹</td>
          <td></td>
        </tr>

        <tr>
          <td>2026-03-29</td>
          <td>孟璇</td>
          <td>陳巧玲牧師</td>
          <td>文祺、以帆</td>
          <td>榕榕</td>
          <td>琴:睿甫｜吉:昶翰｜鼓:為聖｜斯:至忠</td>
          <td>宗明</td>
          <td></td>
          <td>莞茹</td>
          <td>欣仁</td>
          <td>薰聲</td>
          <td>盈君</td>
          <td>小以琳</td>
          <td></td>
        </tr>
      </tbody>
    </table>
  </div>


<script>
const table = document.getElementById("roster");
const select = document.getElementById("personSelect");
const filterInput = document.getElementById("personFilter");
const clearBtn = document.getElementById("clearBtn");
const exportIcsBtn = document.getElementById("exportIcsBtn");
const occCount = document.getElementById("occCount");
const dayCount = document.getElementById("dayCount");
const hitPeople = document.getElementById("hitPeople");

function norm(s){
  return String(s||"").replace(/\s+/g," ").trim();
}
function escapeRegExp(s){
  return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");
}

function extractNamesFromCell(text, isBand){
  const t = norm(text);
  if(!t) return [];
  const out = [];

  if(isBand){
    t.split(/[｜|]/).forEach(part=>{
      const seg = part.split(/[:：]/);
      if(seg.length >= 2){
        const name = norm(seg.slice(1).join(":"));
        if(name) out.push(name);
      }
    });
  }else{
    t.split(/[、,，/｜]/).forEach(n=>{
      n = norm(n);
      if(n) out.push(n);
    });
  }
  return out;
}

function cellHasName(text, name){
  const t = norm(text);
  const n = norm(name);
  if(!t || !n) return false;

  if(t.includes(":") || t.includes("：")){
    return t.split(/[｜|]/).some(part=>{
      const seg = part.split(/[:：]/);
      return seg.length >= 2 && norm(seg.slice(1).join(":")) === n;
    });
  }

  if(t === n) return true;
  const re = new RegExp(`(^|[、,，/\\s｜])${escapeRegExp(n)}([、,，/\\s｜]|$)`);
  return re.test(t);
}

function clearHighlight(){
  table.querySelectorAll(".highlight").forEach(td=>td.classList.remove("highlight"));
  table.querySelectorAll("tbody tr").forEach(tr=>tr.classList.remove("row-hit"));
  occCount.textContent = "出現次數：0";
  dayCount.textContent = "有幾天：0";
  hitPeople.textContent = "命中人數：0";
}

function getHeaders(){
  return Array.from(table.querySelectorAll("thead th")).map(th => norm(th.textContent));
}

function buildNameList(){
  const headers = getHeaders();
  const set = new Set();

  table.querySelectorAll("tbody tr").forEach(tr=>{
    const tds = Array.from(tr.children).filter(el => el.tagName === "TD");
    if(!tds.length) return;

    if(tds.length >= 2 && (tds[1].colSpan || 1) > 1) return;

    let col = 0;
    for(const td of tds){
      const span = td.colSpan || 1;
      const header = headers[col] || "";
      const text = td.textContent;

      if(header === "日期" || header === "講員" || header === "備註"){
        col += span;
        continue;
      }

      const t = norm(text);
      if(t.includes("暫停") || t.includes("春節主日")){
        col += span;
        continue;
      }

      if(header === "樂團"){
        extractNamesFromCell(text, true).forEach(n => set.add(n));
      }else{
        extractNamesFromCell(text, false).forEach(n => set.add(n));
      }

      col += span;
    }
  });

  return Array.from(set).sort((a,b)=>a.localeCompare(b,"zh-Hant"));
}

const allNames = buildNameList();

function fillSelect(){
  while(select.options.length > 1) select.remove(1);
  allNames.forEach(n=>{
    const opt = document.createElement("option");
    opt.value = n;
    opt.textContent = n;
    select.appendChild(opt);
  });
}
fillSelect();

function applyHighlightMany(names){
  clearHighlight();
  const list = Array.from(new Set((names||[]).map(norm).filter(Boolean)));
  if(!list.length) return;

  let occ = 0;
  const days = new Set();

  table.querySelectorAll("tbody tr").forEach(tr=>{
    const tds = Array.from(tr.querySelectorAll("td"));
    if(!tds.length) return;

    const date = norm(tds[0].textContent);
    let hitRow = false;

    for(let i=1;i<tds.length;i++){
      const td = tds[i];
      const text = td.textContent;

      let hitCell = false;
      for(const name of list){
        if(cellHasName(text, name)){
          hitCell = true;
          break;
        }
      }

      if(hitCell){
        td.classList.add("highlight");
        occ++;
        hitRow = true;
      }
    }

    if(hitRow){
      tr.classList.add("row-hit");
      if(date) days.add(date);
    }
  });

  occCount.textContent = `出現次數：${occ}`;
  dayCount.textContent = `有幾天：${days.size}`;
  hitPeople.textContent = `命中人數：${list.length}`;
}

filterInput.addEventListener("input", () => {
  const q = norm(filterInput.value).toLowerCase();

  if(!q){
    select.value = "";
    clearHighlight();
    return;
  }

  const matches = allNames.filter(n => n.toLowerCase().includes(q));

  select.value = "";
  applyHighlightMany(matches);
});

select.addEventListener("change", () => {
  const v = norm(select.value);
  filterInput.value = v;
  if(!v){
    clearHighlight();
    return;
  }
  applyHighlightMany([v]);
});

clearBtn.addEventListener("click", () => {
  filterInput.value = "";
  select.value = "";
  clearHighlight();
});

function pad2(n){ return String(n).padStart(2,"0"); }

function toIcsDateTimeLocal(dateStr, hh=9, mm=0){
  const d = new Date(dateStr + "T00:00:00");
  d.setHours(hh, mm, 0, 0);
  const y = d.getFullYear();
  const m = pad2(d.getMonth()+1);
  const da = pad2(d.getDate());
  const H = pad2(d.getHours());
  const M = pad2(d.getMinutes());
  const S = pad2(d.getSeconds());
  return `${y}${m}${da}T${H}${M}${S}`;
}

function icsEscape(s){
  return String(s||"")
    .replace(/\\/g,"\\\\")
    .replace(/\n/g,"\\n")
    .replace(/,/g,"\\,")
    .replace(/;/g,"\\;");
}

function uid(){
  return (crypto?.randomUUID?.() || (Date.now()+"-"+Math.random().toString(16).slice(2))) + "@roster";
}

function buildEventsForPerson(personName){
  const name = norm(personName);
  if(!name) return [];

  const headers = getHeaders();
  const events = [];

  table.querySelectorAll("tbody tr").forEach(tr=>{
    const tds = Array.from(tr.querySelectorAll("td"));
    if(!tds.length) return;

    const date = norm(tds[0].textContent);
    if(!date) return;

    const roles = [];

    for(let i=1;i<tds.length;i++){
      const header = headers[i] || "";
      if(header === "講員" || header === "備註") continue;

      const text = tds[i].textContent;

      if(header === "樂團"){
        const bandNames = extractNamesFromCell(text, true);
        if(bandNames.includes(name)) roles.push("樂團");
      }else{
        if(cellHasName(text, name)) roles.push(header);
      }
    }

    if(!roles.length) return;

    events.push({ date, roles });
  });

  return events;
}

function buildIcs(personName, events){
  const now = new Date();
  const y = now.getUTCFullYear();
  const m = pad2(now.getUTCMonth()+1);
  const d = pad2(now.getUTCDate());
  const H = pad2(now.getUTCHours());
  const M = pad2(now.getUTCMinutes());
  const S = pad2(now.getUTCSeconds());
  const dtstamp = `${y}${m}${d}T${H}${M}${S}Z`;

  const lines = [];
  lines.push("BEGIN:VCALENDAR");
  lines.push("VERSION:2.0");
  lines.push("PRODID:-//Church Roster//ICS Export//ZH");
  lines.push("CALSCALE:GREGORIAN");
  lines.push("METHOD:PUBLISH");

  events.forEach(ev=>{
    const dtstart = toIcsDateTimeLocal(ev.date, 10, 30);
    const dtend   = toIcsDateTimeLocal(ev.date, 12, 0);
    const summary = `教會事奉：${ev.roles.join("／")}`;
    const desc    = `同工：${personName}\n日期：${ev.date}\n服事：${ev.roles.join("、")}`;

    lines.push("BEGIN:VEVENT");
    lines.push(`UID:${uid()}`);
    lines.push(`DTSTAMP:${dtstamp}`);
    lines.push(`DTSTART:${dtstart}`);
    lines.push(`DTEND:${dtend}`);
    lines.push(`SUMMARY:${icsEscape(summary)}`);
    lines.push(`DESCRIPTION:${icsEscape(desc)}`);
    lines.push("END:VEVENT");
  });

  lines.push("END:VCALENDAR");
  return lines.join("\r\n");
}

function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/calendar;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function resolvePeopleForExport(){
  const fromSelect = norm(select.value);
  if(fromSelect) return [fromSelect];

  const q = norm(filterInput.value);
  if(!q) return [];

  const exact = allNames.find(n => norm(n) === q);
  if(exact) return [exact];

  const qLower = q.toLowerCase();
  const matches = allNames.filter(n => n.toLowerCase().includes(qLower));
  return matches;
}

function pickOneFromList(list){
  return new Promise((resolve) => {
    const overlay = document.createElement("div");
    overlay.style.position = "fixed";
    overlay.style.inset = "0";
    overlay.style.background = "rgba(0,0,0,.35)";
    overlay.style.zIndex = "9999";
    overlay.style.display = "flex";
    overlay.style.alignItems = "center";
    overlay.style.justifyContent = "center";
    overlay.style.padding = "16px";

    const box = document.createElement("div");
    box.style.background = "#fff";
    box.style.borderRadius = "12px";
    box.style.maxWidth = "420px";
    box.style.width = "100%";
    box.style.maxHeight = "70vh";
    box.style.overflow = "auto";
    box.style.boxShadow = "0 10px 30px rgba(0,0,0,.2)";
    box.style.padding = "12px";

    const title = document.createElement("div");
    title.textContent = "選擇要匯出的同工";
    title.style.fontSize = "16px";
    title.style.fontWeight = "700";
    title.style.padding = "8px 8px 12px 8px";

    const tip = document.createElement("div");
    tip.textContent = `目前搜尋命中 ${list.length} 人，請點選其中一位：`;
    tip.style.fontSize = "14px";
    tip.style.color = "#444";
    tip.style.padding = "0 8px 10px 8px";

    const btnAll = document.createElement("button");
    btnAll.type = "button";
    btnAll.textContent = "匯出全部命中";
    btnAll.style.width = "100%";
    btnAll.style.padding = "10px 12px";
    btnAll.style.margin = "0 0 10px 0";
    btnAll.style.fontSize = "16px";

    const listWrap = document.createElement("div");

    const cancel = document.createElement("button");
    cancel.type = "button";
    cancel.textContent = "取消";
    cancel.style.width = "100%";
    cancel.style.padding = "10px 12px";
    cancel.style.marginTop = "10px";
    cancel.style.fontSize = "16px";

    btnAll.addEventListener("click", () => {
      overlay.remove();
      resolve(list);
    });

    cancel.addEventListener("click", () => {
      overlay.remove();
      resolve(null);
    });

    list.forEach(name => {
      const b = document.createElement("button");
      b.type = "button";
      b.textContent = name;
      b.style.width = "100%";
      b.style.padding = "10px 12px";
      b.style.margin = "6px 0";
      b.style.fontSize = "16px";
      b.addEventListener("click", () => {
        overlay.remove();
        resolve([name]);
      });
      listWrap.appendChild(b);
    });

    box.appendChild(title);
    box.appendChild(tip);
    box.appendChild(btnAll);
    box.appendChild(listWrap);
    box.appendChild(cancel);
    overlay.appendChild(box);
    document.body.appendChild(overlay);
  });
}

exportIcsBtn.addEventListener("click", async () => {
  let candidates = resolvePeopleForExport();

  if(!candidates.length){
    alert("請在搜尋框輸入同工名字（可輸入一個字也行），再按匯出 ICS。");
    return;
  }

  if(candidates.length > 1){
    const picked = await pickOneFromList(candidates);
    if(!picked) return;
    candidates = picked;
  }

  if(candidates.length === 1){
    const person = candidates[0];
    const events = buildEventsForPerson(person);
    if(!events.length){
      alert("這位同工在表格中沒有找到服事紀錄。");
      return;
    }
    const ics = buildIcs(person, events);
    const safeName = person.replace(/[\\/:*?"<>|]/g,"_");
    downloadText(`教會事奉表-${safeName}.ics`, ics);
    return;
  }

  const mergedLines = [];
  mergedLines.push("BEGIN:VCALENDAR");
  mergedLines.push("VERSION:2.0");
  mergedLines.push("PRODID:-//Church Roster//ICS Export//ZH");
  mergedLines.push("CALSCALE:GREGORIAN");
  mergedLines.push("METHOD:PUBLISH");

  const now = new Date();
  const y = now.getUTCFullYear();
  const mo = pad2(now.getUTCMonth()+1);
  const da = pad2(now.getUTCDate());
  const H = pad2(now.getUTCHours());
  const M = pad2(now.getUTCMinutes());
  const S = pad2(now.getUTCSeconds());
  const dtstamp = `${y}${mo}${da}T${H}${M}${S}Z`;

  candidates.forEach(person => {
    const events = buildEventsForPerson(person);
    events.forEach(ev => {
      const dtstart = toIcsDateTimeLocal(ev.date, 10, 30);
      const dtend   = toIcsDateTimeLocal(ev.date, 12, 0);
      const summary = `教會事奉：${person}（${ev.roles.join("／")}）`;
      const desc    = `同工：${person}\n日期：${ev.date}\n服事：${ev.roles.join("、")}`;

      mergedLines.push("BEGIN:VEVENT");
      mergedLines.push(`UID:${uid()}`);
      mergedLines.push(`DTSTAMP:${dtstamp}`);
      mergedLines.push(`DTSTART:${dtstart}`);
      mergedLines.push(`DTEND:${dtend}`);
      mergedLines.push(`SUMMARY:${icsEscape(summary)}`);
      mergedLines.push(`DESCRIPTION:${icsEscape(desc)}`);
      mergedLines.push("END:VEVENT");
    });
  });

  mergedLines.push("END:VCALENDAR");
  const merged = mergedLines.join("\r\n");
  downloadText(`教會事奉表-搜尋命中${candidates.length}人.ics`, merged);
});
</script>

</body>
</html>
